---
title: "PCOSP"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Run the script

## 1. Build the PCOSP model

```{r build_and_select_models}
require(switchBox)
library(vcdExtra)
library(caret)
library(forestplot)
library(pROC)
library(survcomp)
library(survival)
require(data.table)
library(reportROC)
library(verification)
library(grid)
library(ggplot2)
library(scales)
library(BiocParallel)
library(microbenchmark)

source(file.path("..", "R", "1_buildPCOSPmodel.R"))
source(file.path("..", "R", "utilities.R"))
source(file.path("..", "R", "formatValidationCohorts.R"))
source(file.path("..", "R", "estimatePCOSPscore.R"))
```

```{r load_data}
load(file.path("..", "data", "trainingCohorts.rda"))
```

```{r train_model}
# Set seed for calculation (using old R < 3.6 RNG)
set.seed(1987, sample.kind="Rounding")

# Build the models using the selected random seed
system.time({
selectedModels <- buildPCOSPmodels(trainingCohorts, numModels=1000, nthread=15)
})
```

## 2. Calcualte and Validate Meta-Estimate Statistics

```{r calculate_stats}
source(file.path("..", "R", "2_validateMetaestimateCalculation.R"))
load(file.path("..", "data", "validationCohorts.rda"))

# Select the validation cohorts we want to includ
include <- c("TCGA", "PCSI", "Kirby", "ICGC_arr", "UNC", "Chen", "OUH", 
             "Zhang", "Winter", "Collisson")

# Subset to selected cohorts
validationCohorts <- validationCohorts[include]

# Fix names to look nice
names(validationCohorts) <- gsub("_arr", "-array", names(validationCohorts))

# Identify which cohorts contain sequencing data
seqCohorts <- c("PCSI", "TCGA", "Kirby")

# Calculate your validation statistics
system.time({
        validationStats <- calculateValidationStats(validationCohorts,
                                            selectedModels,
                                            seqCohorts=seqCohorts,
                                            nthread=15)
})
```

```{r forest_plots}
source(file.path('..', 'R', 'forestPlotMetaEstimate.R'))

forestPlotMetaEstimate(validationStats,
                       stat="dIndex",
                       isSummary=c(rep(FALSE, 10), rep(TRUE, 3)))

```


```{r forest_plot_cIndex}
forestPlotMetaEstimate(validationStats,
                       stat="cIndex",
                       isSummary=c(rep(FALSE, 10), rep(TRUE, 3)))
```

```{r}
source(file.path("..", "R", "aucMetaEstimates.R"))

aucStats <- aucMetaEstimates(validationCohorts, validationStats, 
                            seqCohorts=seqCohorts)
```

```{r plot_ROC_curve}
source(file.path("..", "R", "plotROCcurves.R"))

formattedValCohorts <- formatValidationCohorts(validationCohorts)
PCOSPscores <- validationStats$PCOSPscores
colours <- c("chartreuse3", "magenta", "#fb9a99", "turquoise3", "darkgoldenrod1",
             "wheat4", "green", "red", "cornflowerblue", "mediumorchid2")

plotROCcurves(formattedValCohorts, PCOSPscores, colours)
```

```{r 3_model_random_label_shuffling}
source(file.path("..", "R", "3_modelRandomLabelShuffling.R"))
set.seed(1987, sample.kind="Rounding")

system.time({
    randomLabelModels <- buildRandomLabelShufflingModel(trainingCohorts, 
                                                    numModels=1000, nthread=15)
})
```

```{r density_plot}
source(file.path("..", "R", "densityPlot.R"))

densityPlotModel(formattedValCohorts, selectedModels=randomLabelModels, seqCohorts, 
                 vlines=c(0.69, 0.72, 0.70), nthread=15)
```

```{r 4_random_gene_assignment_models}
source(file.path("..", "R", "4_randomGeneAssignmentModel.R"))
set.seed(1987, sample.kind="Rounding")

## These results will differ from the Code Ocean capsule due to sampling.
## For the original results use: original = TRUE; this will be about 10x slower
##     than the new method.
system.time({
    randomGeneModels1 <- buildRandomGeneAssignmentModels(trainingCohorts, 
                                                         numModels=1000,
                                                         nthread=15,
                                                         original=FALSE)
})
```

```{r random_gene_assignment_density}
densityPlotModel(formattedValCohorts, selectedModels=randomGeneModels1, seqCohorts, 
                 vlines=c(0.69, 0.72, 0.70), nthread=15)
```

```{r hyper_gsea_models}
source(file.path("..", "R", "5_hyperGSApathwayAnalysis.R"))

dataDir <- file.path("..", "data")
pathwayDataDir <- file.path(dataDir, "Pathway_db_files")
referenceGenes <- read.table(file.path(pathwayDataDir, "reference_genes.txt"))[, 1]
PCOSPgenes <- read.table(file.path(pathwayDataDir, "pcosp_genes.txt"))[, 1]

GSCfiles <- c("hallmark.h.all.v6.1.symbols.gmt",
              "canonical.c2.cp.v6.1.symbols.gmt",
              "GOmolecular.c5.mf.v6.1.symbols.gmt",
              "GOcellular.c5.cc.v6.1.symbols.gmt")

GSCpaths <- vapply(GSCfiles, 
                   function(file, pathwayDataDir) file.path(pathwayDataDir, file),
                   pathwayDataDir,
                   FUN.VALUE=character(1))

results <- lapply(GSCpaths,
                  function(filePath, PCOSPgenes, referenceGenes, adjMethod) 
                      fitGSEAtoGeneSetCollection(filePath=filePath, 
                                                 PCOSPgenes=PCOSPgenes, 
                                                 referenceGenes=referenceGenes,
                                                 adjMethod=adjMethod),
                  PCOSPgenes=PCOSPgenes,
                  referenceGenes=referenceGenes,
                  adjMethod="fdr"
                  )

```


























