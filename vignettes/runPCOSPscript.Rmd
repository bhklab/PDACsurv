---
title: "PCOSP"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Run the script

## 1. Build the PCOSP model

```{r build_and_select_models}
require(switchBox)
library(vcdExtra)
library(caret)
library(forestplot)
library(pROC)
library(survcomp)
library(survival)
require(data.table)
library(reportROC)
library(verification)
library(grid)
library(ggplot2)
library(scales)
library(BiocParallel)
library(microbenchmark)

source(file.path("..", "R", "1_buildPCOSPmodel.R"))
source(file.path("..", "R", "utilities.R"))
source(file.path("..", "R", "formatValidationCohorts.R"))
source(file.path("..", "R", "estimatePCOSPscore.R"))
```

```{r train_models}
load(file.path("..", "data", "trainingCohorts.rda"))

# Set seed for calculation (using old R < 3.6 RNG)
set.seed(1987, sample.kind="Rounding")

# Build the models using the selected random seed
system.time({
selectedModels <- buildPCOSPmodels(trainingCohorts, numModels=1000, nthread=15)
})
```

## 2. Calcualte and Validate Meta-Estimate Statistics

```{r calculate_stats}
source(file.path("..", "R", "2_validateMetaestimateCalculation.R"))
load(file.path("..", "data", "validationCohorts.rda"))

# Select the validation cohorts we want to includ
include <- c("TCGA", "PCSI", "Kirby", "ICGC_arr", "UNC", "Chen", "OUH", 
             "Zhang", "Winter", "Collisson")

validationCohorts <- validationCohorts[include]
names(validationCohorts) <- gsub("_arr", "-array", names(validationCohorts))


system.time({
        validationStats <- calculateValidationStats(validationCohorts,
                                            selectedModels,
                                            seqCohorts=c("PCSI", "TCGA", "Kirby"),
                                            nthread=15)
})

```


```{r forest_plots}
source(file.path('..', 'R', 'forestPlotMetaEstimate.R'))

forestPlotMetaEstimate(validationStats,
                       stat="dIndex",
                       isSummary=c(rep(FALSE, 10), rep(TRUE, 3)))

```
```{r }
forestPlotMetaEstimate(validationStats,
                       stat="cIndex",
                       isSummary=c(rep(FALSE, 10), rep(TRUE, 3)))
```
